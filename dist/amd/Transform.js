define(["EventEmitter","Util","Compatible","TFCompatible","Event","Status"],function(t,e,o,s,r,i){function n(t,e){n.superClass.call(this),this._dom=t,this._executeInTime=e,this._steps=[],this._store={},this._index=0,this._transformRecord="",this._compatible=s.instance(),this._listen()}return e.inherit(n,t),n.prototype._listen=function(){function t(t){return function(e){o.emit(t,e)}}var o=this,s=o._compatible;this.on(r.on,function(e,i){i===r.end&&(o._monitorEnd||(o._monitorEnd=t(i),o._on(s.parseEvent(i),o._monitorEnd)))}),this.on(r.end,function(t,i){if(o._index<o._steps.length){var n=o._steps[o._index],a=i.propertyName.replace(s.prefix,"");n.status.digest(a),n.status.isDone()&&(o._index++,n.next?(o.emit(r.next,n),n.next()):o.emit(r.over,n))}e.stopPropagation(i)})},n.prototype.setExecuteInTime=function(t){return this._executeInTime=t,this},n.prototype.reStore=function(){o.css(this._dom,this._store,"",this);for(var t;this._index>0;)this._index--,t=this._steps[this._index].status,t.reset();return this._transformRecord="",this},n.prototype.reflow=function(){return o.reflow(this._dom),this},n.prototype.reExecute=function(){return this.reStore().reflow(),this.execute()},n.prototype.execute=function(){if(this._index<this._steps.length){var t=this._steps[this._index];"execute"in t&&t.execute()}return this},n._apiMap={changeTo:{c:"color",bc:"backgroundColor",fs:"fontSize",br:"borderRadius",bo:"border",o:"opacity",l:"left",r:"right",t:"top",b:"bottom",w:"width",h:"height"},moveTo:{t:"top",l:"left",b:"bottom",r:"right"},moveBy:{x:"translateX",y:"translateY",z:"translateZ","2d":"translate","3d":"translate3d"},scaleBy:{x:"scaleX",y:"scaleY",z:"scaleZ","2d":"scale","3d":"scale3d"},rotateBy:{x:"rotateX",y:"rotateY",z:"rotateZ","3d":"rotate3d"},skewBy:{x:"skewX",y:"skewY","2d":"skew"}},n.prototype._step=function(t,e,s){var r=this,i=r._compatible,n={},a=r._steps.length;if(a>0){var p=r._steps[a-1],c=p.next;c?(p.next=function(){c(),o.css(r._dom,i.parseCSS("transition"),t,r),o.css(r._dom,e(),"",r)},r._index===r._steps.length&&(o.css(r._dom,i.parseCSS("transition"),t,r),o.css(r._dom,e(),"",r))):(p.next=function(){o.css(r._dom,i.parseCSS("transition"),t,r),o.css(r._dom,e(),"",r)},r._index===r._steps.length&&p.next())}else n.execute=function(){o.css(r._dom,i.parseCSS("transition"),t,r),o.css(r._dom,e(),"",r)},this._executeInTime&&n.execute();n.status=s,n.next=!1,this._steps.push(n)},n.prototype._combineTransform=function(t){return this._transformRecord+=t.join(" "),this._transformRecord},n.prototype._fillTransformParams=function(t,o,s){var r=this._compatible,i=r.parseCSS("transform"),n=r.parseCSS("transition");t=r.clone(t,o);var a=t.api;if(!a)throw new Error("不健全的配置项！");e.forIn(a,function(t,e){s.push(t+"("+e+")")}),i in this._store||(this._store[i]=e.css(this._dom,i)),n in this._store||(this._store[n]=e.css(this._dom,n))},n.prototype._transform=function(t,e){var o=this,s=o._compatible,r=s.cssMap("transform"),n=[];this._fillTransformParams(t,e,n);var a=new i;a.add("transform"),t.property=r,this._step(s.parseTransition(t),function(){var t={},e=s.parseCSS("transform");return t[e]=o._combineTransform(n),t},a)},n.prototype._fillCSSParams=function(t,o,s,r,i){var n,a=this,p=a._compatible.parseCSS("transition");return t=a._compatible.clone(t,o),t instanceof Array||(t=[t]),e.each(t,function(t){if(!t.api)throw new Error("不健全的配置！");e.forIn(t.api,function(o,c){n=this._compatible.addStatus(i,o),r[o]=c,o in this._store||(this._store[o]=e.css(this._dom,o)),p in this._store||(this._store[p]=e.css(this._dom,p)),t.property=n,s.push(a._compatible.parseTransition(t))},a)}),t},n.prototype._css=function(t,e){var o=[],s={},r=new i;this._fillCSSParams(t,e,o,s,r),this._step(o.join(","),function(){return s},r)},n.prototype.moveTo=function(t){var e=n._apiMap.moveTo;return t=this._patchMoveTo(t,e),this._css(t,e),this},n.prototype._patchMoveTo=function(t,o){t instanceof Array||(t=[t]);var s,r,i=this._dom,n={};return e.each(t,function(t){e.forKey(t,function(t){t in o&&(r=o[t],s=e.css(i,r),s&&"auto"!==s||(n[r]=0))})}),e.forIn(n,function(t,o){e.css(i,t,o)}),t},n.prototype.changeTo=function(t){var e=n._apiMap.changeTo;return t=this._patchMoveTo(t,n._apiMap.moveTo),this._css(t,e),this},n.prototype.moveBy=function(t){var e=n._apiMap.moveBy;return this._transform(t,e),this},n.prototype.scaleBy=function(t){var e=n._apiMap.scaleBy;return this._transform(t,e),this},n.prototype.skewBy=function(t){var e=n._apiMap.skewBy;return this._transform(t,e),this},n.prototype.rotateBy=function(t){var e=n._apiMap.rotateBy;return this._transform(t,e),this},n.prototype.mock=function(t,o){var s=n._apiMap[t],r={},a=new i,p=[];if("moveTo changeTo".indexOf(t)>-1)return this._fillCSSParams(o,s,p,r,a),[p.join(","),r,a];var c=this._compatible,h=c.parseCSS("transform"),_=[],f=c.cssMap("transform");if("mix"===t){var m,u=this._compatible.peelMould(o),l=0;return e.forIn(n._apiMap,function(t,s){t in o&&(m=o[t],"moveTo"===t||"changeTo"===t?(m=this._patchMoveTo(m,n._apiMap.moveTo),e.each(m,function(t){e.extend(t,u)}),this._fillCSSParams(m,s,p,r,a)):(this._fillTransformParams(m,s,_),l++))},this),l>0&&(a.add("transform"),o.property=f,p.push(c.parseTransition(o))),l>0&&(h=c.parseCSS("transform"),r[h]="old+; "+_.join(" ")),[p.join(","),r,a]}return this._fillTransformParams(o,s,_),a.add("transform"),o.property=f,r[h]="old+; "+_.join(" "),[c.parseTransition(o),r,a]},n.prototype.mix=function(t){var o,s=this._compatible.peelMould(t),r=[],a={},p=new i,c=[],h=0;e.forIn(n._apiMap,function(i,_){i in t&&(o=t[i],"moveTo"===i||"changeTo"===i?(o=this._patchMoveTo(o,n._apiMap.moveTo),e.each(o,function(t){e.extend(t,s)}),this._fillCSSParams(o,_,r,a,p)):(this._fillTransformParams(o,_,c),h++))},this);var _=this,f=_._compatible;if(h>0){var m=f.cssMap("transform");p.add("transform"),t.property=m,r.push(f.parseTransition(t))}return this._step(r.join(","),function(){if(h>0){var t=f.parseCSS("transform");a[t]=_._combineTransform(c,t)}return a},p),this},n.prototype.then=function(t){var e=this._steps.length;if(e>0){var o=this._steps[e-1],s=o.next;o.next=s?function(){s(),t()}:t}else t();return this},n.prototype._on=function(t,o){e.on(this._dom,t,o)},n.prototype._off=function(t,o){e.off(this._dom,t,o)},n.prototype._unListen=function(){this._monitorStart&&this._off(this._compatible.parseEvent(r.start),this._monitorStart),this._monitorEnd&&this._off(this._compatible.parseEvent(r.end),this._monitorEnd)},n.prototype.perspective=function(t){var e=this._compatible,s=this._dom.parentNode;return t===!1?o.css(s,e.parseCSS("transformStyle"),"flat",this):(o.css(s,e.parseCSS("transformStyle"),"preserve-3d",this),o.css(s,e.parseCSS("perspective"),t,this)),this},n});