define(["EventEmitter","Util","Compatible","TFCompatible","Event"],function(t,o,r,s,e){function i(t,o){i.superClass.call(this),this._dom=t,this._executeInTime=o,this._steps=[],this._store={},this._index=0,this._transformRecord="",this._compatible=s.instance(),this._listen()}return o.inherit(i,t),i.prototype._listen=function(){function t(t){return function(o){r.emit(t,o)}}var r=this,s=r._compatible;this.on(e.on,function(o,i){i===e.end&&(r._monitorEnd||(r._monitorEnd=t(i),r._on(s.parseEvent(i),r._monitorEnd)))}),this.on(e.end,function(t,i){if(r._index<r._steps.length){var n=r._steps[r._index],a=i.propertyName.replace(s.prefix,"");if(a in n.status){n.status[a]=!0;var p=n.status,c=o.forIn(p,function(t,o){return o?void 0:!1});c&&(r._index++,n.next?(r.emit(e.next,n),n.next()):r.emit(e.over,n))}}o.stopPropagation(i)})},i.prototype.setExecuteInTime=function(t){return this._executeInTime=t,this},i.prototype.reStore=function(){r.css(this._dom,this._store,"",this);for(var t;this._index>0;)this._index--,t=this._steps[this._index].status,o.forKey(t,function(o){t[o]=!1});return this._transformRecord="",this},i.prototype.reflow=function(){return r.reflow(this._dom),this},i.prototype.reExecute=function(){return this.reStore().reflow(),this.execute()},i.prototype.execute=function(){if(this._index<this._steps.length){var t=this._steps[this._index];"execute"in t&&t.execute()}return this},i._apiMap={changeTo:{c:"color",bc:"backgroundColor",fs:"fontSize",br:"borderRadius",o:"opacity",l:"left",r:"right",t:"top",b:"bottom",w:"width",h:"height"},moveTo:{t:"top",l:"left",b:"bottom",r:"right"},moveBy:{x:"translateX",y:"translateY",z:"translateZ","2d":"translate","3d":"translate3d"},scaleBy:{x:"scaleX",y:"scaleY",z:"scaleZ","2d":"scale","3d":"scale3d"},rotateBy:{x:"rotateX",y:"rotateY",z:"rotateZ","3d":"rotate3d"},skewBy:{x:"skewX",y:"skewY","2d":"skew"}},i.prototype._step=function(t,o,s){var e=this,i=e._compatible,n={},a=e._steps.length;if(a>0){var p=e._steps[a-1],c=p.next;c?(p.next=function(){c(),r.css(e._dom,i.parseCSS("transition"),t,e),r.css(e._dom,o(),"",e)},e._index===e._steps.length&&(r.css(e._dom,i.parseCSS("transition"),t,e),r.css(e._dom,o(),"",e))):(p.next=function(){r.css(e._dom,i.parseCSS("transition"),t,e),r.css(e._dom,o(),"",e)},e._index===e._steps.length&&p.next())}else n.execute=function(){r.css(e._dom,i.parseCSS("transition"),t,e),r.css(e._dom,o(),"",e)},this._executeInTime&&n.execute();n.status=s,n.next=!1,this._steps.push(n)},i.prototype._combineTransform=function(t){return this._transformRecord+=t.join(" "),this._transformRecord},i.prototype._fillTransformParams=function(t,r,s){var e=this._compatible,i=e.parseCSS("transform"),n=e.parseCSS("transition");t=e.clone(t,r);var a=t.api;if(!a)throw new Error("不健全的配置项！");o.forIn(a,function(t,o){s.push(t+"("+o+")")}),i in this._store||(this._store[i]=o.css(this._dom,i)),n in this._store||(this._store[n]=o.css(this._dom,n))},i.prototype._transform=function(t,o){var r=this,s=r._compatible,e=s.cssMap("transform"),i=[];this._fillTransformParams(t,o,i);var n={};n.transform=!1,t.property=e,this._step(s.parseTransition(t),function(){var t={},o=s.parseCSS("transform");return t[o]=r._combineTransform(i),t},n)},i.prototype._addStatus=function(t,o){var r=this._compatible.cssMap(o);return"border-radius"===r?(t["border-bottom-left-radius"]=!1,t["border-top-left-radius"]=!1,t["border-bottom-right-radius"]=!1,t["border-top-right-radius"]=!1):t[r]=!1,r},i.prototype._fillCSSParams=function(t,r,s,e,i){var n,a=this,p=a._compatible.parseCSS("transition");return t=a._compatible.clone(t,r),t instanceof Array||(t=[t]),o.each(t,function(t){if(!t.api)throw new Error("不健全的配置！");o.forIn(t.api,function(r,c){n=this._addStatus(i,r),e[r]=c,r in this._store||(this._store[r]=o.css(this._dom,r)),p in this._store||(this._store[p]=o.css(this._dom,p)),t.property=n,s.push(a._compatible.parseTransition(t))},a)}),t},i.prototype._css=function(t,o){var r=[],s={},e={};this._fillCSSParams(t,o,r,s,e),this._step(r.join(","),function(){return s},e)},i.prototype.moveTo=function(t){var o=i._apiMap.moveTo;return t=this._patchMoveTo(t,o),this._css(t,o),this},i.prototype._patchMoveTo=function(t,r){t instanceof Array||(t=[t]);var s,e,i=this._dom,n={};return o.each(t,function(t){o.forKey(t,function(t){t in r&&(e=r[t],s=o.css(i,e),s&&"auto"!==s||(n[e]=0))})}),o.forIn(n,function(t,r){o.css(i,t,r)}),t},i.prototype.changeTo=function(t){var o=i._apiMap.changeTo;return t=this._patchMoveTo(t,i._apiMap.moveTo),this._css(t,o),this},i.prototype.moveBy=function(t){var o=i._apiMap.moveBy;return this._transform(t,o),this},i.prototype.scaleBy=function(t){var o=i._apiMap.scaleBy;return this._transform(t,o),this},i.prototype.skewBy=function(t){var o=i._apiMap.skewBy;return this._transform(t,o),this},i.prototype.rotateBy=function(t){var o=i._apiMap.rotateBy;return this._transform(t,o),this},i.prototype.mock=function(t,r){var s=i._apiMap[t],e={},n={},a=[];if("moveTo changeTo".indexOf(t)>-1)return this._fillCSSParams(r,s,a,e,n),[a.join(","),e,n];var p=this._compatible,c=p.parseCSS("transform"),h=[],f=p.cssMap("transform");if("mix"===t){var _,m=this._compatible.peelMould(r),u=0;return o.forIn(i._apiMap,function(t,s){t in r&&(_=r[t],"moveTo"===t||"changeTo"===t?(_=this._patchMoveTo(_,i._apiMap.moveTo),o.each(_,function(t){o.extend(t,m)}),this._fillCSSParams(_,s,a,e,n)):(this._fillTransformParams(_,s,h),u++))},this),u>0&&(n.transform=!1,r.property=f,a.push(p.parseTransition(r))),u>0&&(c=p.parseCSS("transform"),e[c]="old+; "+h.join(" ")),[a.join(","),e,n]}return this._fillTransformParams(r,s,h),n.transform=!1,r.property=f,e[c]="old+; "+h.join(" "),[p.parseTransition(r),e,n]},i.prototype.mix=function(t){var r,s=this._compatible.peelMould(t),e=[],n={},a={},p=[],c=0;o.forIn(i._apiMap,function(h,f){h in t&&(r=t[h],"moveTo"===h||"changeTo"===h?(r=this._patchMoveTo(r,i._apiMap.moveTo),o.each(r,function(t){o.extend(t,s)}),this._fillCSSParams(r,f,e,n,a)):(this._fillTransformParams(r,f,p),c++))},this);var h=this,f=h._compatible;if(c>0){var _=f.cssMap("transform");a.transform=!1,t.property=_,e.push(f.parseTransition(t))}return this._step(e.join(","),function(){if(c>0){var t=f.parseCSS("transform");n[t]=h._combineTransform(p,t)}return n},a),this},i.prototype.then=function(t){var o=this._steps.length;if(o>0){var r=this._steps[o-1],s=r.next;r.next=s?function(){s(),t()}:t}else t();return this},i.prototype._on=function(t,r){o.on(this._dom,t,r)},i.prototype._off=function(t,r){o.off(this._dom,t,r)},i.prototype._unListen=function(){this._monitorStart&&this._off(this._compatible.parseEvent(e.start),this._monitorStart),this._monitorEnd&&this._off(this._compatible.parseEvent(e.end),this._monitorEnd)},i.prototype.perspective=function(t){var o=this._compatible,s=this._dom.parentNode;return t===!1?r.css(s,o.parseCSS("transformStyle"),"flat",this):(r.css(s,o.parseCSS("transformStyle"),"preserve-3d",this),r.css(s,o.parseCSS("perspective"),t,this)),this},i});