define(["EventEmitter"],function(t){function r(t,e){return r.superClass.call(this),this._dom=t,this._executeInTime=e,this._steps=[],this._store={},this._index=0,this._listen(),this}return Util.inherit(r,t),r.prototype._combineTransform=function(t,r){var e=Util.css(this._dom,r);return e&&"none"!==e?e+" "+t.join(" "):t.join(" ")},r._keyMap={duration:"transitionDuration","function":"transitionTimingFunction",delay:"transitionDelay"},r.prototype.setExecuteInTime=function(t){this._executeInTime=t},r.prototype.moveBy=function(t){var e=r._apiMap.moveBy;return this._transform(t,e),this},r.prototype.then=function(t){var r=this._steps.length;if(r>0){var e=this._steps[r-1],i=e.next;e.next=i?function(){i(),t()}:t}else t();return this},r.prototype._step=function(t,e,i){var n=r,s=this,o={},a=s._steps.length;if(a>0){var c=s._steps[a-1],p=c.next;p?(c.next=function(){p(),Util.css(s._dom,n._theCore.css.transition,t),Util.css(s._dom,e())},s._index===s._steps.length&&(Util.css(s._dom,n._theCore.css.transition,t),Util.css(s._dom,e()))):(c.next=function(){Util.css(s._dom,n._theCore.css.transition,t),Util.css(s._dom,e())},s._index===s._steps.length&&c.next())}else o.execute=function(){Util.css(s._dom,n._theCore.css.transition,t),Util.css(s._dom,e())},this._executeInTime&&o.execute();o.status=i,o.next=!1,this._steps.push(o)},r.prototype.reStore=function(){Util.css(this._dom,this._store);for(var t;this._index>0;){this._index--,t=this._steps[this._index].status;for(var r in t)t[r]=!1}return this},r.prototype._reflow=function(){return this._dom.offsetWidth=this._dom.offsetWidth,this},r.prototype.reExecute=function(){return this.reStore()._reflow(),this.execute()},r.prototype.execute=function(){if(this._index<this._steps.length){var t=this._steps[this._index];"execute"in t&&t.execute()}return this},r.prototype._transform=function(t,e){var i=this,n=r,s=i._cssMap("transform"),o=[];t=this._fillTransformParams(t,e,o);var a={};return a.transform=!1,t.transitionProperty=s,this._step(n._parseTransition(t),function(){var t={},r=n._theCore.css.transform;return t[r]=i._combineTransform(o,r),t},a),this},r._clone=function(t,e){var i,n=r;if(t instanceof Array){i=[];for(var s=0;s<t.length;s++)i.push(n._clone(t[s],e))}else if("object"==typeof t){i={};for(var o in t)o in n._keyMap?i[n._keyMap[o]]=n._clone(t[o],e):o in e&&("api"in i||(i.api={}),i.api[e[o]]=n._clone(t[o],e))}else i=t;return i},r.prototype._fillTransformParams=function(t,e,i){var n=r,s=n._theCore.css.transform,o=n._theCore.css.transition;t=n._clone(t,e);var a=t.api;if(a)for(var c in a)i.push(c+"("+a[c]+")");return s in this._store||(this._store[s]=Util.css(this._dom,s)),o in this._store||(this._store[o]=Util.css(this._dom,o)),t},r.prototype.scaleBy=function(t){var e=r._apiMap.scaleBy;return this._transform(t,e),this},r.prototype._cssMap=function(t){var e,i=r._prefix;switch(t){case"transform":e="-webkit-"===i?i+t:t;break;case"backgroundColor":e="background-color";break;case"borderRadius":e="border-radius";break;case"fontSize":e="font-size";break;case"color":case"top":case"bottom":case"left":case"width":case"height":case"opacity":case"right":e=t;break;default:throw new Error(t+" not supported!")}return e},r._apiMap={changeTo:{c:"color",bc:"backgroundColor",fs:"fontSize",br:"borderRadius",o:"opacity",l:"left",r:"right",t:"top",b:"bottom",w:"width",h:"height"},moveTo:{t:"top",l:"left",b:"bottom",r:"right"},moveBy:{x:"translateX",y:"translateY",z:"translateZ","2d":"translate","3d":"translate3d"},scaleBy:{x:"scaleX",y:"scaleY",z:"scaleZ","2d":"scale","3d":"scale3d"},rotateBy:{x:"rotateX",y:"rotateY",z:"rotateZ","3d":"rotate3d","2d":"rotate"},skewBy:{x:"skewX",y:"skewY","2d":"skew"},perspective:{p:"perspective"}},r.prototype._css=function(t,r){var e=[],i={},n={};return this._fillCSSParams(t,r,e,i,n),this._step(e.join(","),function(){return i},n),this},r.prototype.perspectiveTo=function(t){var e=r._apiMap.perspective;return this._transform(t,e),this},r.prototype.skewBy=function(t){var e=r._apiMap.skewBy;return this._transform(t,e),this},r.prototype.rotateBy=function(t){var e=r._apiMap.rotateBy;return this._transform(t,e),this},r._extend=function(t,r){for(var e in r)e in t||(t[e]=r[e])},r.prototype.mix=function(t){var e,i=r,n=i._keyMap,s={};for(var o in n)o in t&&(s[o]=t[o],t[n[o]]=t[o]);var a,c=[],p={},_={},f=i._apiMap,u=[],h=0;for(var o in f)if(o in t)if(e=t[o],a=f[o],"moveTo"===o||"changeTo"===o){e instanceof Array||(e=[e]);for(var l=0,m=e.length;m>l;l++)i._extend(e[l],s);this._fillCSSParams(e,a,c,p,_)}else this._fillTransformParams(e,a,u),h++;var d;if(h>0){d=this;var v=d._cssMap("transform");_.transform=!1,t.transitionProperty=v,c.push(i._parseTransition(t))}return this._step(c.join(","),function(){if(h>0){var t=i._theCore.css.transform;p[t]=d._combineTransform(u,t)}return p},_),this},r.prototype.moveTo=function(t){var e=r._apiMap.moveTo;return this._css(t,e),this},r.prototype.changeTo=function(t){var e=r._apiMap.changeTo;return this._css(t,e),this},r.prototype._addStatus=function(t,r){var e=this._cssMap(r);return"border-radius"===e?(t["border-bottom-left-radius"]=!1,t["border-top-left-radius"]=!1,t["border-bottom-right-radius"]=!1,t["border-top-right-radius"]=!1):t[e]=!1,e},r.prototype._fillCSSParams=function(t,e,i,n,s){var o,a,c,p=r,_=p._theCore.css.transition;t=p._clone(t,e),t instanceof Array||(t=[t]);for(var f=0,u=t.length;u>f;f++){o=t[f],a=o.api||{};for(var h in a)c=this._addStatus(s,h),n[h]=a[h],h in this._store||(this._store[h]=Util.css(this._dom,h)),_ in this._store||(this._store[_]=Util.css(this._dom,_)),o.transitionProperty=c,i.push(p._parseTransition(o))}},r._parseTransition=function(t){function e(r,e){if(e in t)return t[e];var i;switch(e){case"transitionDuration":i="1s";break;case"transitionTimingFunction":i="linear";break;case"transitionDelay":i="0s"}return i}return r._transitionTpl.replace(/<(.*?)>/g,e)},r._status={ED:0,ING:1},r._theCore=null,r._prefix="",r.getCore=function(){var t=r;if(!t._theCore){t._prefix=Compatible.instance().prefix,t._transitionTpl="<transitionProperty> <transitionDuration> <transitionTimingFunction> <transitionDelay>";var e=t._prefix.replace(/-/g,"");t._theCore={event:function(){return"moz"===e?{transitionEnd:"transitionend",transitionStart:"transitionstart"}:{transitionEnd:e+"TransitionEnd",transitionStart:e+"TransitionStart"}}(),css:function(){var t;return t="moz"===e?function(t){return t}:function(t){return e+t[0].toUpperCase()+t.substr(1)},{transition:t("transition"),transform:t("transform"),perspective:t("perspective"),transformStyle:t("transformStyle"),transformOrigin:t("transformOrigin"),backfaceVisibility:t("backfaceVisibility")}}()}}return t._theCore},r.getCore(),r.prototype.compatible=function(t){var e=r.getCore(),i={};for(var n in t)i[e.css[n]]=t[n];return i},r.prototype._on=function(t,r){return Util.on(this._dom,t,r),this},r.prototype._off=function(t,r){return Util.off(this._dom,t,r),this},r.prototype._unListen=function(){var t=this,e=r;t._monitorStart&&this._off(e._theCore.event.transitionStart,t._monitorStart),t._monitorEnd&&this._off(e._theCore.event.transitionEnd,t._monitorEnd)},r.prototype._listen=function(){function t(t){return function(r){e.emit(t,r)}}var e=this;this.on(Event.on,function(r,i){i===Event.start?e._monitorStart||(e._monitorStart=t(i),Util.on(e._dom,e._compatible.parseEvent(i),e._monitorStart)):i===Event.end&&(e._monitorEnd||(e._monitorEnd=t(i),Util.on(e._dom,e._compatible.parseEvent(i),e._monitorEnd)))}),this.on(Event.end,function(t,i){if(e._index<e._steps.length){var n=e._steps[e._index],s=i.propertyName.replace(r.prefix,"");if(s in n.status){n.status[s]=!0;var o=!0,a=n.status;for(var c in a)if(!a[c]){o=!1;break}o&&(e._status=it._status.ED,e.emit(Event.end,n),e._index++,n.next?n.next():e.emit(Event.done,n))}}Util.stopPropagation(i)}),this.on(Event.start,function(t,i){e._status=r._status.ING})},r.prototype.perspective=function(t){var e=r,i=this._dom.parentNode;return t===!1?Util.css(i,e._theCore.css.transformStyle,"flat"):(Util.css(i,e._theCore.css.transformStyle,"preserve-3d"),Util.css(i,e._theCore.css.perspective,t)),this},r});