define(["Checker","KFCompatible","Util","Event","EventEmitter"],function(t,e,n,i,r){function s(){s.superClass.call(this),this._classStore={},this._classMap={},this._keyframeMap={},this._keyframeStore={};var t=e.instance();this._compatible=t,this._classId=function(t){return"class("+t+")"},this._keyframeId=function(t){return"keyframe("+t+")"},this._classText=function(t,e){return"."+t.replace(/\s+/g," .")+" "+e},this._keyframeText=function(e,n){return t.keyframe(e)+n}}return n.inherit(s,r),s.prototype.defineClass=function(t,e){return t=t.trim(),this._classMap[t]=e,t},s.prototype.defineKeyframe=function(e,i){return null!==i&&(t.object.check(arguments)&&(i=arguments[0],e=n.random.name(8)),this._keyframeMap[e]=i),e},s.prototype.compile=function(){var t={},e={};n.forIn(this._classMap,function(e,n){t[e]=this._compileClass(n)},this),n.forIn(this._keyframeMap,function(t,n){e[t]=this._compileKeyframe(n)},this),this._classMap={},this._keyframeMap={},this._effect(t,e)},s.prototype._absorb=function(t,e,i,r,s){var o,c;n.forIn(t,function(t,n){o=e(t),c=i(t,n),t in r?this._refreshSheet(c,o):s.appendChild(this._styleSheet(c,o)),r[t]=n},this),t=null},s.prototype._effect=function(t,e){var n=this._fragment();this._absorb(t,this._classId,this._classText,this._classStore,n),this._absorb(e,this._keyframeId,this._keyframeText,this._keyframeStore,n),n.effect()},s.prototype._fragment=function(){var t=document.createDocumentFragment();return t.effect=function(){document.querySelector("head").appendChild(t)},t},s.prototype._styleSheet=function(t,e){var n=document.createElement("style");return n.type="text/css",n.id=e,n.appendChild(document.createTextNode(t)),this.emit(i.style,e,t),n},s.prototype.clear=function(){n.forIn(this._classStore,function(t){this._clearSheet(this._classId(t))},this),n.forIn(this._keyframeStore,function(t){this._clearSheet(this._keyframeId(t))},this),this._classStore={},this._keyframeStore={},this._classMap={},this._keyframeMap={}},s.prototype._refreshSheet=function(t,e){document.getElementById(e).innerHTML=t,this.emit(i.style,e,t)},s.prototype._clearSheet=function(t){document.querySelector("head").removeChild(document.getElementById(t))},s.prototype._compileClass=function(t){return"{"+this._compileContent(t)+"}"},s.prototype._compileContent=function(t){var e={},i=[];return n.forIn(t,function(t,n){i.push(this._compatible.patch(t,n,e))},this),n.forIn(e,function(t,e){i.push(this._compatible.patchCombine(t,e))},this),i.join("")},s.prototype._compileKeyframe=function(t){var e="{";return n.forIn(t,function(t,n){e+=this._compileFrame(t,n)},this),e+="}"},s.prototype._compileFrame=function(t,e){return this._compatible.percent(t)+this._compileClass(e)},s.instance=function(){return s._compiler||(s._compiler=new s),s._compiler},s});