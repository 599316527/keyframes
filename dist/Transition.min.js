function Transition(t,i){Transition.superClass.call(this),this._dom=t,this._executeInTime=i,this._steps=[],this._store={},this._index=0,this._transformRecord="",this._firstRun=!0,this._compatible=TFCompatible.instance(),this._listen()}Util.inherit(Transition,EventEmitter),Transition.prototype._listen=function(){function t(t){return function(n){i.emit(t,n)}}var i=this,n=i._compatible;this.on(Event.on,function(o,s){s===Event.end&&(i._monitorEnd||(i._monitor=t(s),i._on(n.parseEvent(s),i._monitor)))}),this.on(Event.end,function(t,o){if(i._index<i._steps.length){var s=i._steps[i._index],r=o.propertyName.replace(n.prefix,"");s.status.digest(r),s.status.isDone()&&(i._index++,s.next?(i.emit(Event.next,s),s.next()):i.emit(Event.over,s))}Util.stopPropagation(o)})},Transition.prototype.setExecuteInTime=function(t){return this._executeInTime=t,this},Transition.prototype.reStore=function(){Compatible.css(this._dom,this._store,"",this);for(var t;this._index>0;)this._index--,t=this._steps[this._index].status,t.reset();return this._transformRecord="",this},Transition.prototype.reflow=function(){return Compatible.reflow(this._dom),this},Transition.prototype.execute=function(){if(this._firstRun||(this.reStore().reflow(),this._firstRun=!1),this._index<this._steps.length){var t=this._steps[this._index];"execute"in t&&t.execute()}return this},Transition._apiMap={changeTo:{c:"color",bc:"backgroundColor",fs:"fontSize",br:"borderRadius",bo:"border",o:"opacity",l:"left",r:"right",t:"top",b:"bottom",w:"width",h:"height"},moveTo:{t:"top",l:"left",b:"bottom",r:"right"},moveBy:{x:"translateX",y:"translateY",z:"translateZ","2d":"translate","3d":"translate3d"},scaleBy:{x:"scaleX",y:"scaleY",z:"scaleZ","2d":"scale","3d":"scale3d"},rotateBy:{x:"rotateX",y:"rotateY",z:"rotateZ","3d":"rotate3d"},skewBy:{x:"skewX",y:"skewY","2d":"skew"}},Transition.prototype._step=function(t,i,n){var o=this,s=o._compatible,r={},e=o._steps.length,a=function(t,i,n){o.emit(Event.css,t,i,n)};if(e>0){var p=o._steps[e-1],c=p.next;c?(p.next=function(){c(),Compatible.css(o._dom,s.parseCSS("transition"),t,a),Compatible.css(o._dom,i(),"",a)},o._index===o._steps.length&&(Compatible.css(o._dom,s.parseCSS("transition"),t,a),Compatible.css(o._dom,i(),"",a))):(p.next=function(){Compatible.css(o._dom,s.parseCSS("transition"),t,a),Compatible.css(o._dom,i(),"",a)},o._index===o._steps.length&&p.next())}else r.execute=function(){Compatible.css(o._dom,s.parseCSS("transition"),t,a),Compatible.css(o._dom,i(),"",a)},this._executeInTime&&r.execute();r.status=n,r.next=!1,this._steps.push(r)},Transition.prototype._combineTransform=function(t){return this._transformRecord+=t.join(" "),this._transformRecord},Transition.prototype._fillTransformParams=function(t,i,n){var o=this._compatible,s=o.parseCSS("transform"),r=o.parseCSS("transition");t=o.clone(t,i);var e=t.api;if(!e)throw new Error("不健全的配置项！");Util.forIn(e,function(t,i){n.push(t+"("+i+")")}),s in this._store||(this._store[s]=Util.css(this._dom,s)),r in this._store||(this._store[r]=Util.css(this._dom,r))},Transition.prototype._transform=function(t,i){var n=this,o=n._compatible,s=o.cssMap("transform"),r=[];this._fillTransformParams(t,i,r);var e=new Status;e.add("transform"),t.property=s,this._step(o.parseTransition(t),function(){var t={},i=o.parseCSS("transform");return t[i]=n._combineTransform(r),t},e)},Transition.prototype._fillCSSParams=function(t,i,n,o,s){var r,e=this,a=e._compatible.parseCSS("transition");return t=e._compatible.clone(t,i),t instanceof Array||(t=[t]),Util.each(t,function(t){if(!t.api)throw new Error("不健全的配置！");Util.forIn(t.api,function(i,p){r=this._compatible.addStatus(s,i),o[i]=p,i in this._store||(this._store[i]=Util.css(this._dom,i)),a in this._store||(this._store[a]=Util.css(this._dom,a)),t.property=r,n.push(e._compatible.parseTransition(t))},e)}),t},Transition.prototype._css=function(t,i){var n=[],o={},s=new Status;this._fillCSSParams(t,i,n,o,s),this._step(n.join(","),function(){return o},s)},Transition.prototype.moveTo=function(t){var i=Transition._apiMap.moveTo;return t=this._patchMoveTo(t,i),this._css(t,i),this},Transition.prototype._patchMoveTo=function(t,i){t instanceof Array||(t=[t]);var n,o,s=this._dom,r={};return Util.each(t,function(t){Util.forIn(t,function(t){t in i&&(o=i[t],n=Util.css(s,o),n&&"auto"!==n||(r[o]=0))})}),Util.forIn(r,function(t,i){Util.css(s,t,i)}),t},Transition.prototype.changeTo=function(t){var i=Transition._apiMap.changeTo;return t=this._patchMoveTo(t,Transition._apiMap.moveTo),this._css(t,i),this},Transition.prototype.moveBy=function(t){var i=Transition._apiMap.moveBy;return this._transform(t,i),this},Transition.prototype.scaleBy=function(t){var i=Transition._apiMap.scaleBy;return this._transform(t,i),this},Transition.prototype.skewBy=function(t){var i=Transition._apiMap.skewBy;return this._transform(t,i),this},Transition.prototype.rotateBy=function(t){var i=Transition._apiMap.rotateBy;return this._transform(t,i),this},Transition.prototype.mock=function(t,i){var n=Transition._apiMap[t],o={},s=new Status,r=[];if("moveTo changeTo".indexOf(t)>-1)return this._fillCSSParams(i,n,r,o,s),[r.join(","),o,s];var e=this._compatible,a=e.parseCSS("transform"),p=[],c=e.cssMap("transform");if("mix"===t){var h,_=this._compatible.peelMould(i),f=0;return Util.forIn(Transition._apiMap,function(t,n){t in i&&(h=i[t],"moveTo"===t||"changeTo"===t?(h=this._patchMoveTo(h,Transition._apiMap.moveTo),Util.each(h,function(t){Util.extend(t,_)}),this._fillCSSParams(h,n,r,o,s)):(this._fillTransformParams(h,n,p),f++))},this),f>0&&(s.add("transform"),i.property=c,r.push(e.parseTransition(i))),f>0&&(a=e.parseCSS("transform"),o[a]="old+; "+p.join(" ")),[r.join(","),o,s]}return this._fillTransformParams(i,n,p),s.add("transform"),i.property=c,o[a]="old+; "+p.join(" "),[e.parseTransition(i),o,s]},Transition.prototype.mix=function(t){var i,n=this._compatible.peelMould(t),o=[],s={},r=new Status,e=[],a=0;Util.forIn(Transition._apiMap,function(p,c){p in t&&(i=t[p],"moveTo"===p||"changeTo"===p?(i=this._patchMoveTo(i,Transition._apiMap.moveTo),Util.each(i,function(t){Util.extend(t,n)}),this._fillCSSParams(i,c,o,s,r)):(this._fillTransformParams(i,c,e),a++))},this);var p=this,c=p._compatible;if(a>0){var h=c.cssMap("transform");r.add("transform"),t.property=h,o.push(c.parseTransition(t))}return this._step(o.join(","),function(){if(a>0){var t=c.parseCSS("transform");s[t]=p._combineTransform(e,t)}return s},r),this},Transition.prototype.then=function(t){var i=this._steps.length;if(i>0){var n=this._steps[i-1],o=n.next;n.next=o?function(){o(),t()}:t}else t();return this},Transition.prototype._on=function(t,i){Util.on(this._dom,t,i)},Transition.prototype._off=function(t,i){Util.off(this._dom,t,i)},Transition.prototype._unListen=function(){this._monitorEnd&&this._off(this._compatible.parseEvent(Event.end),this._monitorEnd)},Transition.prototype.perspective=function(t){var i=this._compatible,n=this._dom.parentNode;return t===!1?Compatible.css(n,i.parseCSS("transformStyle"),"flat",this):(Compatible.css(n,i.parseCSS("transformStyle"),"preserve-3d",this),Compatible.css(n,i.parseCSS("perspective"),t,this)),this};