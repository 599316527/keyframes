function EventEmitter(){this._routes={}}function Checker(){this._list=Util.arg2Ary(arguments)}function Pitch(t,e,n){this._router=[],Checker.ssFunction.check(arguments)&&this.use(t,e,n)}function Compatible(){var t=new Pitch,e=this;t.use("prefixOnly","text-shadow transition transition-timing-function animation-timing-function transform-origin",function(t,n){return e.prefix+t+":"+n+";"}),t.use("needAll","box-shadow border-radius",function(t,n){return e.prefix+t+":"+n+";"+t+":"+n+";"}),t.use("extend","translateX translateY translateZ translate translate3d rotateX rotateY rotateZ rotate rotate3d skewX skewY skewZ skew scaleZ scaleX scaleY scale3d scale perspective",function(t,e,n){return"transform"in n?n.transform+=" "+t+"("+e+")":n.transform=t+"("+e+")",""}),t.use("transform","transform",function(t,e,n){return"transform"in n?n.transform+=" "+e:n.transform=e,""}),t.use("animation","animation",function(t,n){return e.prefix+t+":"+e.parseAnimation(n)+";"}),t.use("special","background-gradient",function(t,e){return"!!!"}),t.use("rest","*",function(t,e){return t+":"+e+";"}),this._pitch=t,this._combine=new Pitch("combine","transform",function(t,n){return e.prefix+t+":"+n+";"})}function Compiler(){Compiler.superClass.call(this),this._classStore={},this._classMap={},this._keyframeMap={},this._keyframeStore={};var t=Compatible.instance();this._compatible=t,this._classId=function(t){return"class("+t+")"},this._keyframeId=function(t){return"keyframe("+t+")"},this._classText=function(t,e){return"."+t+" "+e},this._keyframeText=function(e,n){return t.keyframe(e)+n}}function Keyframe(t,e){if(Keyframe.superClass.call(this),this._compiler=Compiler.instance(),this._compatible=Compatible.instance(),this._init(t),Checker.array.check([e])){var n=this;Util.each(e,function(t){n._animationStatus[t.name]=!1}),this._animations=e}else this._animations=[e],this._animationStatus[e.name]=!1;return this}var Util={inherit:function(t,e){var n=new Function;n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.superClass=e},arg2Ary:function(t){return Array.prototype.slice.call(t,0)},each:function(t,e){for(var n=0;n<t.length&&e(t[n],n,t)!==!1;n++);return n===t.length},random:{generator:[function(){return String.fromCharCode(48+Math.round(9*Math.random()))},function(){return String.fromCharCode(65+Math.round(25*Math.random()))},function(){return String.fromCharCode(97+Math.round(25*Math.random()))}],word:function(t){var e;return e=0===t?Math.floor(2*Math.random())+1:Math.floor(3*Math.random()),Util.random.generator[e]()},name:function(t){t=t||6;for(var e="",n=0;t>n;n++)e+=Util.random.word(n);return e}}};EventEmitter.event={once:"once",all:"all"},EventEmitter.prototype.on=function(t,e,n){t in this._routes?this._routes[t].push({fn:e,option:n}):this._routes[t]=[{fn:e,option:n}]},EventEmitter.prototype.once=function(t,e,n){n||(n={}),n.type=EventEmitter.event.once,this.on(t,e,n)},EventEmitter.prototype.callWithScope=function(t,e,n){n=n||[],e&&"scope"in e?t.apply(e.scope,n):t.apply(this,n)},EventEmitter.prototype.all=function(t,e,n){var i,r,o={},a=[],s=t.length;if(0===s)return void this.callWithScope(e,n);for(r=0;s>r;r++)i=t[r],o[i]=!1;var c=this,p=function(t){return function(i,r){i in o&&(o[i]=!0,a[t]=r);var s=!0;for(var p in o)if(o[p]===!1){s=!1;break}s&&c.callWithScope(e,n,a)}};for(r=0;s>r;r++)i=t[r],this.on(i,p(r),{type:EventEmitter.event.all})},EventEmitter.prototype.emit=function(t){var e,n,i,r,o,a,s=this._routes[t],c=[];if(s){for(var p=0,m=s.length;m>p;p++)e=s[p],r=e.fn,o=e.option,o?(n=o.scope,i=o.type):(n=!1,i=!1),n?r.apply(n,Util.arg2Ary(arguments)):r.apply(this,Util.arg2Ary(arguments)),i&&(i===EventEmitter.event.once?c.push(e):i===EventEmitter.event.all&&c.push(e));if(c.length>0){var l=[],u=0,f=0,h=s.length,y=c.length;for(a=c[f];h>u;)e=s[u],e===a?(f++,a=y>f?c[f]:-1):l.push(e),u++;0===l.length?delete this._routes[t]:this._routes[t]=l}}};var Event={style:"0",start:"1"};Checker.prototype.check=function(t){var e=this;if(t.length!==e._list.length)return!1;var n,i,r=Util.each(t,function(t,r){if(n=e._list[r],i=typeof n,"string"===i){if(typeof t!==n)return!1}else if("function"===i&&!(t instanceof n))return!1});return r},Checker.stringObject=new Checker("string","object"),Checker.object=new Checker("object"),Checker.ssFunction=new Checker("string","string","function"),Checker.array=new Checker(Array),Pitch.prototype.use=function(t,e,n){return this._router.push({name:t,keys:e+" ",handler:n}),this},Pitch.prototype.next=function(t,e,n,i){var r=this._router[t];return r?"*"===r.keys.trim()?r.handler(e.trim(),n,i):r.keys.indexOf(e)>-1?r.handler(e.trim(),n,i):this.next(t+1,e,n,i):""},Pitch.prototype["do"]=function(t,e,n){return this.next(0,t,e,n)},Compatible.prototype.prefix=function(){var t=navigator.userAgent,e=t.indexOf("Opera")>-1,n=t.indexOf("Maxthon")>-1,i=!e&&t.indexOf("compatible")>-1&&t.indexOf("MSIE")>-1||t.indexOf("Trident")>-1,r=t.indexOf("Firefox")>-1,o=t.indexOf("Safari")>-1&&t.indexOf("Chrome")<1,a=t.indexOf("Chrome")>-1,s=t.indexOf("WebKit")>-1;return i?"-ms-":s||o||a||n?"-webkit-":e?"-o-":r?"-moz-":""}(),Compatible._keyMap={name:"animationName",duration:["animationDuration","1s"],"function":["animationTimingFunction","linear"],delay:["animationDelay","0s"],count:["animationIterationCount",1],direction:["animationDirection","normal"],state:["animationPlayState","running"],mode:["animationFillMode","forwards"]},Compatible.prototype.parseAnimation=function(t){function e(t,e){return e in n?n[e]:Compatible._keyMap[e][1]}Checker.array.check(arguments)||(t=[t]);var n,i=[],r=this.animationTpl();return console.log(t),Util.each(t,function(t){n=t,console.log(t),i.push(r.replace(/<(.*?)>/g,e))}),i.join(",")},Compatible.prototype.animationTpl=function(){return this._animationTpl||("-moz-"===this.prefix?(this._animationTpl="<duration> <function> <delay> <direction> <mode> <count> <state> <name>",this._closeReg={start:"\\s",end:"(?:\\s*)$"}):(this._animationTpl="<name> <duration> <function> <delay> <count> <direction> <mode>",this._closeReg={start:"^(?:\\s*)",end:"\\s"})),this._animationTpl},Compatible.prototype.keyframe=function(t){return"@"+this.prefix+"keyframes "+t},Compatible.prototype.percent=function(t){t=(t+"").trim();var e=t.split(/\s+/);return e.join("%, ")+"%"},Compatible.prototype.patchCombine=function(t,e){return this._combine["do"](t+" ",e)},Compatible.prototype.patch=function(t,e,n){return this._pitch["do"](t+" ",e,n)},Compatible.instance=function(){return Compatible._compatible||(Compatible._compatible=new Compatible),Compatible._compatible},Compatible.prototype.addAnimation=function(t,e){var n=this.parseCSS("animation"),i=this.css(t,n);i&&""!==i&&(e=i+","+e),this.css(t,n,e)},Compatible.prototype.parseCSS=function(t){var e=this.prefix.replace(/-/g,"");return Compatible.prototype.parseCSS="moz"===e?function(t){return t in Compatible._keyMap?Compatible._keyMap[t]:t}:function(t){return t in Compatible._keyMap&&(t=Compatible._keyMap[t]),e+t[0].toUpperCase()+t.substr(1)},this.parseCSS(t)},Compatible.prototype.css=function(t,e,n){return"undefined"!=typeof window.getComputedStyle?Compatible.prototype.css=function(t,e,n){if(void 0!==n)return t.style[e]=n,n;var i=window.getComputedStyle(t,null)[e];return""===i?t.style[e]:i}:"undefined"!=typeof t.currentStyle&&(Compatible.prototype.css=function(t,e,n){if(void 0!==n)return t.style[e]=n,n;var i=t.currentStyle[e];return""===i?t.style[e]:i}),this.css(t,e,n)},Compatible.prototype.addClass=function(t,e){t.className.match(new RegExp("(\\s|^)"+e+"(\\s|$)"))||(t.className=(t.className+" "+e).trim())},Compatible.prototype.removeClass=function(t,e){t.className=t.className.replace(new RegExp("(\\s|^)"+e+"(\\s|$)")," ").trim()},Util.inherit(Compiler,EventEmitter),Compiler.prototype.defineClass=function(t,e){if(Checker.object.check(arguments))e=arguments[0],t=Util.random.name(8);else if(!Checker.stringObject.check(arguments))throw new Error("incorrect parameter, metaData is required！");return this._classMap[t]=e,t},Compiler.prototype.defineKeyframe=function(t,e){if(Checker.object.check(arguments))e=arguments[0],t=Util.random.name(8);else if(!Checker.stringObject.check(arguments))throw new Error("incorrect parameter, metaData is required！");return this._keyframeMap[t]=e,t},Compiler.prototype.compile=function(){var t,e={},n={};for(var i in this._classMap)t=this._classMap[i],e[i]=this._compileClass(t),delete this._classMap[i];for(var r in this._keyframeMap)t=this._keyframeMap[r],n[r]=this._compileKeyframe(t),delete this._keyframeMap[r];this._effect(e,n)},Compiler.prototype._absorb=function(t,e,n,i,r){var o,a;for(var s in t)o=e(s),a=n(s,t[s]),s in i?this._refreshSheet(a,o):r.appendChild(this._styleSheet(a,o)),i[s]=t[s],delete t[s]},Compiler.prototype._effect=function(t,e){var n=this._fragment();this._absorb(t,this._classId,this._classText,this._classStore,n),this._absorb(e,this._keyframeId,this._keyframeText,this._keyframeStore,n),n.effect()},Compiler.prototype._fragment=function(){var t=document.createDocumentFragment();return t.effect=function(){document.querySelector("head").appendChild(t)},t},Compiler.prototype._styleSheet=function(t,e){var n=document.createElement("style");return n.type="text/css",n.id=e,n.innerHTML=t,this.emit(Event.style,e,t),n},Compiler.prototype._refreshSheet=function(t,e){document.getElementById(e).innerHTML=t,this.emit(Event.style,e,t)},Compiler.prototype._compileClass=function(t){var e,n="{",i={};for(e in t)n+=this._compatible.patch(e,t[e],i);for(e in i)n+=this._compatible.patchCombine(e,i[e]);return n+="}"},Compiler.prototype._compileKeyframe=function(t){var e="{";for(var n in t)e+=this._compileFrame(n,t[n]);return e+="}"},Compiler.prototype._compileFrame=function(t,e){return this._compatible.percent(t)+this._compileClass(e)},Compiler.instance=function(){return Compiler._compiler||(Compiler._compiler=new Compiler),Compiler._compiler},Util.inherit(Keyframe,EventEmitter),Keyframe.prototype._init=function(t){this._dom=t,this._animationStatus={}},Keyframe.prototype.start=function(){var t=this._compatible.parseAnimation(this._animations);return this.emit(Event.start),this._compatible.addAnimation(this._dom,t),this},Keyframe.prototype.css=function(t,e){return this._compatible.css(this._dom,t,e)},Keyframe.prototype.addClass=function(t){return this._compatible.addClass(this._dom,t),this},Keyframe.prototype.removeClass=function(t){return this._compatible.removeClass(this._dom,t),this},Keyframe.defineKeyframe=function(t,e){Compiler.instance().defineKeyframe(t,e)},Keyframe.defineClass=function(t,e){Compiler.instance().defineClass(t,e)},Keyframe.compile=function(){Compiler.instance().compile()};