function EventEmitter(){this._routes={}}function Promise(){Promise.superClass.call(this)}function Deferred(){this.state=Deferred.state.unfulfilled,this.promise=new Promise}function Checker(){this._list=Util.arg2Ary(arguments)}function Pitch(t,e,i){this._router=[],Checker.ssFunction.check(arguments)&&this.use(t,e,i)}function Compatible(){var t=new Pitch,e=this;t.use("prefixOnly","text-shadow transition transition-timing-function animation-timing-function transform-origin",function(t,i){return e.prefix+t+":"+i+";"}),t.use("needAll","box-shadow border-radius",function(t,i){return e.prefix+t+":"+i+";"+t+":"+i+";"}),t.use("extend","translateX translateY translateZ translate translate3d rotateX rotateY rotateZ rotate rotate3d skewX skewY skewZ skew scaleZ scaleX scaleY scale3d scale perspective",function(t,e,i){return"transform"in i?i.transform+=" "+t+"("+e+")":i.transform=t+"("+e+")",""}),t.use("transform","transform",function(t,e,i){return"transform"in i?i.transform+=" "+e:i.transform=e,""}),t.use("animation","animation",function(t,i){return e.prefix+t+":"+e.parseAnimation(i)+";"}),t.use("specialA","background",function(t,i){return t+":"+i.replace(/linear-gradient/g,e.prefix+"linear-gradient")+";"}),t.use("specialB","mask-image",function(t,i){return e.prefix+t+":"+i.replace(/linear-gradient/g,e.prefix+"linear-gradient")+";"}),t.use("rest","*",function(t,e){return t+":"+e+";"}),this._pitch=t,this._combine=new Pitch("combine","transform",function(t,i){return e.prefix+t+":"+i+";"})}function Compiler(){Compiler.superClass.call(this),this._classStore={},this._classMap={},this._keyframeMap={},this._keyframeStore={};var t=Compatible.instance();this._compatible=t,this._classId=function(t){return"class("+t+")"},this._keyframeId=function(t){return"keyframe("+t+")"},this._classText=function(t,e){return"."+t+" "+e},this._keyframeText=function(e,i){return t.keyframe(e)+i}}function ClassProxy(t,e){return e?this._define(t,e):this._className=t,this}function FrameProxy(t,e){return this._define(t,e)}function Keyframe(t,e,i){function n(t){return function(){r.emit(t,arguments)}}if(Keyframe.superClass.call(this),this._compiler=Compiler.instance(),this._compatible=Compatible.instance(),this._init(t),e=Util.extend(e,i))if(Checker.array.check([e])){var r=this;Util.each(e,function(t){r._animationStatus[t.name]=!1}),this._animations=e}else this._animations=[e],this._animationStatus[e.name]=!1;else this._animations=[];return this.on(Event.on,function(t,e){e===Event.start?r._monitorStart||(r._monitorStart=n(e),Util.on(r._dom,r._compatible.parseEvent(e),r._monitorStart)):e===Event.end?r._monitorEnd||(r._monitorEnd=n(e),Util.on(r._dom,r._compatible.parseEvent(e),r._monitorEnd)):e===Event.iteration&&(r._monitorIteration||(r._monitorIteration=n(e),Util.on(r._dom,r._compatible.parseEvent(e),r._monitorIteration)))}),this}var Util={rewrite:function(t,e){if(!e)return t;for(var i in e)t[i]=e[i];return t},define:function(t){t=t.split(".");for(var e,i=window;e=t.shift();)e in i||(i[e]={}),i=i[e]},extend:function(t,e){if(!t)return e;if(e)for(var i in e)i in t||(t[i]=e[i]);return t},inherit:function(t,e){var i=new Function;i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t,t.superClass=e},xInA:function(t,e){var i=-1;return Util.each(e,function(e,n){return e===t?(i=n,!1):void 0}),i},arg2Ary:function(t){return Array.prototype.slice.call(t,0)},each:function(t,e){for(var i=0,n=t.length;n>i&&e(t[i],i,t)!==!1;i++);return i===t.length},random:{generator:[function(){return String.fromCharCode(48+Math.round(9*Math.random()))},function(){return String.fromCharCode(65+Math.round(25*Math.random()))},function(){return String.fromCharCode(97+Math.round(25*Math.random()))}],word:function(t){var e;return e=0===t?Math.floor(2*Math.random())+1:Math.floor(3*Math.random()),Util.random.generator[e]()},name:function(t){t=t||6;for(var e="",i=0;t>i;i++)e+=Util.random.word(i);return e}},addClass:function(t,e){t.className.match(new RegExp("(\\s|^)"+e+"(\\s|$)"))||(t.className=(t.className+" "+e).trim())},removeClass:function(t,e){t.className=t.className.replace(new RegExp("(\\s|^)"+e+"(\\s|$)")," ").trim()},css:function(t,e,i){return"undefined"!=typeof window.getComputedStyle?Util.css=function(t,e,i){if(void 0!==i)return t.style[e]=i,i;var n=window.getComputedStyle(t,null)[e];return n?n:t.style[e]}:"undefined"!=typeof t.currentStyle&&(Util.css=function(t,e,i){if(void 0!==i)return t.style[e]=i,i;var n=t.currentStyle[e];return n?n:t.style[e]}),this.css(t,e,i)},on:function(t,e,i){return"addEventListener"in window?Util.on=function(t,e,i){t.addEventListener(e,i,!1)}:"attachEvent"in window&&(Util.on=function(t,e,i){t.attachEvent("on"+e,i)}),this.on(t,e,i)},off:function(t,e,i){"removeEventListener"in window?Util.off=function(t,e,i){t.removeEventListener(e,i,!1)}:"detachEvent"in window&&(Util.off=function(t,e,i){t.detachEvent("on"+e,i)}),this.off(t,e,i)}};EventEmitter.type={once:"once",all:"all"},EventEmitter.prototype.on=function(t,e,i){if(!t)throw new Error("undefined event！");t in this._routes?this._routes[t].push({fn:e,option:i}):this._routes[t]=[{fn:e,option:i}],this.emit(Event.on,t,i)},EventEmitter.prototype.off=function(t,e){if(Checker.string.check(arguments))t in this._routes&&(this._routes[t]=[],this.emit(Event.off,t));else{if(!Checker.sFunction.check(arguments))throw new Error("incorrect parameter!");if(t in this._routes){var i=-1;Util.each(this._routes[t],function(t,n){return t.fn===e?(i=n,!1):void 0}),i>-1&&(this._routes[t].splice(i,1),this.emit(Event.off,t))}}},EventEmitter.prototype.once=function(t,e,i){i||(i={}),i.type=EventEmitter.type.once,this.emit(Event.once,t,i),this.on(t,e,i)},EventEmitter.prototype.callWithScope=function(t,e,i){i=i||[],e&&"scope"in e?t.apply(e.scope,i):t.apply(this,i)},EventEmitter.prototype.all=function(t,e,i){var n={},r=[];if(0===t.length)return void this.callWithScope(e,i);var o=this,a=function(t){return function(a,s){a in n&&(n[a]=!0,r[t]=s);var c=!0;for(var m in n)if(n[m]===!1){c=!1;break}c&&o.callWithScope(e,i,r)}};Util.each(t,function(t,e){n[t]=!1,this.on(t,a(e),{type:EventEmitter.type.all})}),this.emit(Event.all,t,i)},EventEmitter.prototype.emit=function(t){var e,i,n,r,o,a,s=this._routes[t],c=[],m=arguments;if(s){var f=this;if(Util.each(s,function(t){r=t.fn,o=t.option,o?(i=o.scope,n=o.type):(i=!1,n=!1),i?r.apply(i,Util.arg2Ary(m)):r.apply(f,Util.arg2Ary(m)),n&&c.push(t)}),c.length>0){var p=[],u=0,l=0,h=s.length,d=c.length;for(a=c[l];h>u;)e=s[u],e===a?(l++,a=d>l?c[l]:-1):p.push(e),u++;0===p.length?delete this._routes[t]:this._routes[t]=p}}};var Event={style:"Style",beforeStart:"BeforeStart",pause:"Pause",start:"Start",iteration:"Iteration",end:"End",on:"On",off:"Off",stop:"stop",goon:"goon",once:"Once",all:"All",emit:"Emit"};Promise.event={success:"success",error:"error",progress:"progress"},Util.inherit(Promise,EventEmitter),Promise.prototype.then=function(t,e,i){return t&&this.on(Promise.event.success,t),e&&this.on(Promise.event.error,e),i&&this.on(Promise.event.progress,i),this},Deferred.state={unfulfilled:"unfulfilled",fulfilled:"fulfilled",failed:"failed"},Deferred.prototype.resolve=function(){this.state=Deferred.state.fulfilled;var t=Util.arg2Ary(arguments);t.splice(0,0,Promise.event.success),this.promise.emit.apply(this.promise,t)},Deferred.prototype.reject=function(){this.state=Deferred.state.failed;var t=Util.arg2Ary(arguments);t.splice(0,0,Promise.event.error),this.promise.emit.apply(this.promise,t)},Deferred.prototype.progress=function(){var t=Util.arg2Ary(arguments);t.splice(0,0,Promise.event.progress),this.promise.emit.apply(this.promise,t)},Deferred.prototype.all=function(t){var e=t.length,i=this,n=[];return Util.each(t,function(t,r){t.then(function(t){e--,n[r]=t,0===e&&i.resolve(n)},function(t){i.reject(t)})}),this.promise},Checker.prototype.check=function(t){var e=this;if(t.length!==e._list.length)return!1;var i,n,r=Util.each(t,function(t,r){if(i=e._list[r],n=typeof i,"string"===n){if(typeof t!==i)return!1}else if("function"===n&&!(t instanceof i))return!1});return r},Checker.stringObject=new Checker("string","object"),Checker.objectString=new Checker("object","string"),Checker.object=new Checker("object"),Checker.string=new Checker("string"),Checker.ssFunction=new Checker("string","string","function"),Checker.sFunction=new Checker("string","function"),Checker.array=new Checker(Array),Pitch.prototype.use=function(t,e,i){return this._router.push({name:t,keys:e+" ",handler:i}),this},Pitch.prototype.next=function(t,e,i,n){var r=this._router[t];return r?"*"===r.keys.trim()?r.handler(e.trim(),i,n):r.keys.indexOf(e)>-1?r.handler(e.trim(),i,n):this.next(t+1,e,i,n):""},Pitch.prototype["do"]=function(t,e,i){return this.next(0,t,e,i)},Compatible.prototype.prefix=function(){var t=navigator.userAgent,e=t.indexOf("Opera")>-1,i=t.indexOf("Maxthon")>-1,n=!e&&t.indexOf("compatible")>-1&&t.indexOf("MSIE")>-1||t.indexOf("Trident")>-1,r=t.indexOf("Firefox")>-1,o=t.indexOf("Safari")>-1&&t.indexOf("Chrome")<1,a=t.indexOf("Chrome")>-1,s=t.indexOf("WebKit")>-1;return n?"-ms-":s||o||a||i?"-webkit-":e?"-o-":r?"-moz-":""}(),Compatible._keyMap={animation:["animation"],name:["animationName"],duration:["animationDuration","1s"],"function":["animationTimingFunction","linear"],delay:["animationDelay","0s"],count:["animationIterationCount",1],direction:["animationDirection","normal"],state:["animationPlayState","running"],mode:["animationFillMode","forwards"]},Compatible.prototype.parseAnimation=function(t){function e(t,e){return e in i?i[e]:Compatible._keyMap[e][1]}Checker.array.check(arguments)||(t=[t]);var i,n=[],r=this.animationTpl();return Util.each(t,function(t){i=t,n.push(r.replace(/<(.*?)>/g,e))}),n.join(",")},Compatible.prototype.animationTpl=function(){return this._animationTpl||("-moz-"===this.prefix?(this._animationTpl="<duration> <function> <delay> <direction> <mode> <count> <state> <name>",this._closeReg={start:"\\s",end:"(?:\\s*)$"}):(this._animationTpl="<name> <duration> <function> <delay> <count> <direction> <mode>",this._closeReg={start:"^(?:\\s*)",end:"\\s"})),this._animationTpl},Compatible.prototype.regExp=function(t){return new RegExp(this._closeReg.start+t+this._closeReg.end)},Compatible.prototype.keyframe=function(t){return"@"+this.prefix+"keyframes "+t},Compatible.prototype.percent=function(t){t=(t+"").trim();var e=t.split(/\s+/);return e.join("%, ")+"%"},Compatible.prototype.patchCombine=function(t,e){return this._combine["do"](t+" ",e)},Compatible.prototype.patch=function(t,e,i){return this._pitch["do"](t+" ",e,i)},Compatible.instance=function(){return Compatible._compatible||(Compatible._compatible=new Compatible),Compatible._compatible},Compatible.prototype.css=function(t,e,i){return e=this.parseCSS(e),i||""===i?void this.requestAnimationFrame(function(){Util.css(t,e,i)}):Util.css(t,e)},Compatible.prototype.parseCSS=function(t){var e=this.prefix.replace(/-/g,"");return Compatible.prototype.parseCSS="moz"===e?function(t){return t in Compatible._keyMap?Compatible._keyMap[t][0]:t}:function(t){return t in Compatible._keyMap?(t=Compatible._keyMap[t][0],e+t[0].toUpperCase()+t.substr(1)):t},this.parseCSS(t)},Compatible.prototype.parseEvent=function(t){var e=this.prefix.replace(/-/g,"");return Compatible.prototype.parseEvent="moz"===e?function(t){return"animation"+t.toLowerCase()}:function(t){return e+"Animation"+t},this.parseEvent(t)},Compatible.prototype.requestAnimationFrame=function(){return window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),function(t){window.requestAnimationFrame(t)}}(),Util.inherit(Compiler,EventEmitter),Compiler.prototype.defineClass=function(t,e){return this._classMap[t]=e,t},Compiler.prototype.defineKeyframe=function(t,e){return this._keyframeMap[t]=e,t},Compiler.prototype.compile=function(){var t,e={},i={};for(var n in this._classMap)t=this._classMap[n],e[n]=this._compileClass(t),delete this._classMap[n];for(var r in this._keyframeMap)t=this._keyframeMap[r],i[r]=this._compileKeyframe(t),delete this._keyframeMap[r];this._effect(e,i)},Compiler.prototype._absorb=function(t,e,i,n,r){var o,a;for(var s in t)o=e(s),a=i(s,t[s]),s in n?this._refreshSheet(a,o):r.appendChild(this._styleSheet(a,o)),n[s]=t[s],delete t[s]},Compiler.prototype._effect=function(t,e){var i=this._fragment();this._absorb(t,this._classId,this._classText,this._classStore,i),this._absorb(e,this._keyframeId,this._keyframeText,this._keyframeStore,i),i.effect()},Compiler.prototype._fragment=function(){var t=document.createDocumentFragment();return t.effect=function(){document.querySelector("head").appendChild(t)},t},Compiler.prototype._styleSheet=function(t,e){var i=document.createElement("style");return i.type="text/css",i.id=e,i.innerHTML=t,this.emit(Event.style,e,t),i},Compiler.prototype._refreshSheet=function(t,e){document.getElementById(e).innerHTML=t,this.emit(Event.style,e,t)},Compiler.prototype._compileClass=function(t){var e,i="{",n={};for(e in t)i+=this._compatible.patch(e,t[e],n);for(e in n)i+=this._compatible.patchCombine(e,n[e]);return i+="}"},Compiler.prototype._compileKeyframe=function(t){var e="{";for(var i in t)e+=this._compileFrame(i,t[i]);return e+="}"},Compiler.prototype._compileFrame=function(t,e){return this._compatible.percent(t)+this._compileClass(e)},Compiler.instance=function(){return Compiler._compiler||(Compiler._compiler=new Compiler),Compiler._compiler},ClassProxy.prototype._define=function(t,e){this._className=Compiler.instance().defineClass(t,e)},ClassProxy.prototype.hover=function(t){return this._pseudo("hover",t)},ClassProxy.prototype.before=function(t){return this._pseudo("before",t)},ClassProxy.prototype.after=function(t){return this._pseudo("after",t)},ClassProxy.prototype.focus=function(t){return this._pseudo("focus",t)},ClassProxy.prototype._name=function(t){return this._className+":"+t},ClassProxy.prototype._pseudo=function(t,e){if(!e)throw new Error("incorrect parameter, metaData is required！");return Compiler.instance().defineClass(this._name(t),e),this},ClassProxy.prototype.rewrite=function(t,e){if(Checker.objectString.check(arguments))this._pseudo(e,t);else{if(!Checker.object.check(arguments))throw new Error("incorrect parameter！");this._define(this._className,t)}return this},FrameProxy.prototype._define=function(t,e){return this._frame=Compiler.instance().defineKeyframe(t,e),this},FrameProxy.prototype.rewrite=function(t){if(!Checker.object.check(arguments))throw new Error("incorrect parameter！");return this._define(this._frame,t),this},Util.inherit(Keyframe,EventEmitter),Keyframe.prototype._init=function(t){this._dom=t,this._animationStatus={}},Keyframe.prototype.start=function(){var t=this._compatible,e=t.parseAnimation(this._animations),i=this._filter();return this.emit(Event.beforeStart),""!==i?""!==e.trim()?t.css(this._dom,"animation",i+", "+e):t.css(this._dom,"animation",e):""!==e.trim()&&t.css(this._dom,"animation",e),this},Keyframe.prototype.pause=function(t){return this._playState("paused",t),this.emit(Event.pause),this},Keyframe.prototype._filter=function(){var t=this._compatible.css(this._dom,"animation"),e=[];if(t){t=t.split(",");var i=["(?:none)"];Util.each(this._animations,function(t){i.push("(?:"+t.name+")")});var n=this._compatible.regExp(i.join("|"));Util.each(t,function(t){n.test(t)||e.push(t)})}return e.join(",").trim()},Keyframe.prototype.reflow=function(){var t=this._dom;return this._compatible.requestAnimationFrame(function(){t.offsetWidth=t.offsetWidth}),this},Keyframe.prototype.restart=function(){var t=this._compatible;t.css(this._dom,"animation",this._filter());for(var e in this._animationStatus)this._animationStatus[e]=!1;this.reflow(),this.start()},Keyframe.prototype.stop=function(){var t=this._compatible;t.css(this._dom,"animation",this._filter());for(var e in this._animationStatus)this._animationStatus[e]=!1;return this._monitorStart&&(Util.off(this._dom,t.parseEvent(Event.start),this._monitorStart),this._monitorStart=!1),this._monitorEnd&&(Util.off(this._dom,t.parseEvent(Event.end),this._monitorEnd),this._monitorEnd=!1),this._monitorIteration&&(Util.off(this._dom,t.parseEvent(Event.iteration),this._monitorIteration),this._monitorIteration=!1),this.emit(Event.stop),this},Keyframe.prototype.goon=function(t){return this._playState("running",t),this.emit(Event.goon),this},Keyframe.prototype._c2A=function(t){var e=Util.css(this._dom,this._compatible.parseCSS(t));return e.split(/,\s?/)},Keyframe.prototype._playState=function(t,e){var i,n=this._c2A("name"),r=this._c2A("state");if(e)i=Util.xInA(e,n),i>-1&&(r[i]=t);else{var o;Util.each(this._animations,function(e){o=e.name,i=Util.xInA(o,n),i>-1&&(r[i]=t)})}return this._compatible.css(this._dom,"state",r.join(", ")),this},Keyframe.prototype.addClass=function(t){return Util.addClass(this._dom,t),this},Keyframe.prototype.removeClass=function(t){return Util.removeClass(this._dom,t),this},Keyframe.defineKeyframe=function(t,e){if(Checker.object.check(arguments)&&(e=arguments[0],t=Util.random.name(8)),Checker.stringObject.check(arguments))return new FrameProxy(t,e);throw new Error("incorrect parameters!")},Keyframe.defineClass=function(t,e){if(Checker.object.check(arguments)&&(e=arguments[0],t=Util.random.name(8)),Checker.stringObject.check(arguments))return new ClassProxy(t,e);if(Checker.string.check(arguments))return new ClassProxy(t);throw new Error("incorrect parameters!")},Keyframe.pack=function(t){Util.inherit(t,Keyframe);var e=t.cf["class"],i=t.cf.frame;for(var n in e)Keyframe.defineClass(n,e[n]);for(var r in i)Keyframe.defineKeyframe(r,i[r]);t.rewriteClass=function(i,n){e||(e=t.cf["class"]={}),i in e?Util.rewrite(e[i],n):e[i]=n},t.rewriteFrame=function(e,n){i||(i=t.cf.frame={}),e in i?Util.rewrite(i[e],n):i[e]=n}},Keyframe.compile=function(){Compiler.instance().compile()};